<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUKODA | Admin</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="icon" type="image/svg+xml" href="assets/logo/icon-s-black.svg">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        serif: ['Cormorant Garamond', 'Georgia', 'serif'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        black: '#111111',
                        paper: '#FAF8F5',
                        cream: '#F5F0EB',
                        accent: '#B8976A',
                        muted: '#8A8578',
                    },
                }
            }
        }
    </script>
    <style>
        body { background-color: #FAF8F5; color: #111; }
        .grid-line-b { border-bottom: 1px solid #E8E3DD; }
        [x-cloak] { display: none !important; }
        .accent-line { width: 40px; height: 1px; background: #B8976A; }
        .modal-backdrop { background: rgba(17, 17, 17, 0.4); backdrop-filter: blur(4px); }
        .slot-btn { transition: all 0.15s; }
        .slot-btn:hover { background: #B8976A; color: #fff; }
        .slot-btn.selected { background: #B8976A; color: #fff; }
    </style>
</head>
<body class="antialiased font-sans text-sm" x-data="adminApp()" x-init="init()">

    <div class="max-w-[1200px] mx-auto min-h-screen">

        <!-- Login -->
        <div x-show="!authenticated" x-cloak class="min-h-screen flex items-center justify-center px-4">
            <div class="max-w-sm w-full text-center">
                <h1 class="font-serif text-3xl font-light mb-2">SUKODA.</h1>
                <div class="accent-line mx-auto mb-8"></div>
                <p class="text-muted font-light mb-6">Admin paneel</p>
                <form @submit.prevent="login()">
                    <input type="password" x-model="password" placeholder="Parool" 
                        class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-center font-light outline-none focus:border-accent mb-4">
                    <button type="submit" class="w-full bg-accent text-white py-3 text-xs uppercase tracking-[0.2em] font-medium hover:bg-accent/90 transition-colors">
                        Sisene
                    </button>
                    <p x-show="loginError" class="mt-3 text-red-500 text-xs" x-text="loginError"></p>
                </form>
            </div>
        </div>

        <!-- Dashboard -->
        <div x-show="authenticated" x-cloak>

            <!-- Header -->
            <header class="grid-line-b py-4 px-6 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <h1 class="font-serif text-xl font-light">SUKODA.</h1>
                    <span class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium">Admin</span>
                </div>
                <div class="flex items-center gap-4">
                    <button @click="loadData()" class="text-xs text-muted hover:text-black transition-colors">Uuenda</button>
                    <button @click="authenticated = false; password = ''" class="text-xs text-muted hover:text-black transition-colors">Logi välja</button>
                </div>
            </header>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-5 grid-line-b">
                <div class="p-6 border-r border-[#E8E3DD]">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-2">Tänased</p>
                    <p class="font-serif text-2xl font-light" x-text="todayBookings.length">0</p>
                </div>
                <div class="p-6 border-r border-[#E8E3DD]">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-2">See nädal</p>
                    <p class="font-serif text-2xl font-light" x-text="weekBookings.length">0</p>
                </div>
                <div class="p-6 border-r border-[#E8E3DD]">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-2">Aktiivsed tellijad</p>
                    <p class="font-serif text-2xl font-light" x-text="activeSubscriptions.length">0</p>
                </div>
                <div class="p-6 border-r border-[#E8E3DD]">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-2">Tellimused kokku</p>
                    <p class="font-serif text-2xl font-light" x-text="paidOrdersCount">0</p>
                </div>
                <div class="p-6 cursor-pointer hover:bg-cream/30 transition-colors" @click="activeTab = 'followups'">
                    <p class="text-[10px] uppercase tracking-[0.2em] text-accent mb-2">Follow-up</p>
                    <p class="font-serif text-2xl font-light" x-text="followupStats.pending">0</p>
                    <p class="text-[9px] text-muted mt-1" x-text="'Ootel · ' + followupStats.converted + ' konv.'"></p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="grid-line-b px-6 flex gap-6">
                <button @click="activeTab = 'today'" :class="activeTab === 'today' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors">
                    Tänased
                </button>
                <button @click="activeTab = 'week'" :class="activeTab === 'week' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors">
                    See nädal
                </button>
                <button @click="activeTab = 'subscriptions'" :class="activeTab === 'subscriptions' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors">
                    Tellimused
                </button>
                <button @click="activeTab = 'all'" :class="activeTab === 'all' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors">
                    Kõik tellimused
                </button>
                <button @click="activeTab = 'followups'" :class="activeTab === 'followups' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors relative">
                    Follow-ups
                    <span x-show="followupStats.pending > 0" class="absolute -top-1 -right-2 bg-accent text-white text-[9px] rounded-full w-4 h-4 flex items-center justify-center" x-text="followupStats.pending"></span>
                </button>
                <button @click="activeTab = 'giftcards'" :class="activeTab === 'giftcards' ? 'border-b-2 border-accent text-black' : 'text-muted'" class="py-4 text-xs uppercase tracking-[0.15em] transition-colors">
                    Kinkekaardid
                </button>
            </div>

            <!-- Content -->
            <div class="p-6">

                <!-- Loading -->
                <div x-show="loading" class="py-12 text-center">
                    <div class="w-8 h-8 border border-accent border-t-transparent rounded-full animate-spin mx-auto"></div>
                </div>

                <!-- Today's Bookings -->
                <div x-show="activeTab === 'today' && !loading">
                    <h2 class="font-serif text-xl font-light mb-4">Tänased külastused</h2>
                    <template x-if="todayBookings.length === 0">
                        <p class="text-muted font-light py-8 text-center">Täna külastusi ei ole.</p>
                    </template>
                    <div class="space-y-3">
                        <template x-for="b in todayBookings" :key="b.id">
                            <div @click="openBookingDetail(b)" class="bg-white border border-[#E8E3DD] p-5 flex flex-col md:flex-row md:items-center gap-4 cursor-pointer hover:border-accent/50 transition-colors">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium" x-text="b.customerName"></p>
                                    <p class="text-muted text-xs mt-1 truncate" x-text="b.address"></p>
                                </div>
                                <div class="text-right shrink-0">
                                    <p class="font-serif text-lg" x-text="formatTime(b.scheduledAt)"></p>
                                    <p class="text-xs text-muted" x-text="getSizeName(b.size)"></p>
                                </div>
                                <div class="flex gap-2 shrink-0" @click.stop>
                                    <span x-show="b.status === 'scheduled'" class="px-3 py-1 bg-cream text-xs text-accent">Planeeritud</span>
                                    <span x-show="b.status === 'completed'" class="px-3 py-1 bg-green-50 text-xs text-green-600">Tehtud</span>
                                    <span x-show="b.status === 'cancelled'" class="px-3 py-1 bg-red-50 text-xs text-red-500">Tühistatud</span>
                                    <button x-show="b.status === 'scheduled'" @click="completeBooking(b.id)" class="px-3 py-1 bg-accent text-white text-xs hover:bg-accent/90">Tehtud</button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Week's Bookings -->
                <div x-show="activeTab === 'week' && !loading">
                    <h2 class="font-serif text-xl font-light mb-4">Selle nädala graafik</h2>
                    <template x-if="weekBookings.length === 0">
                        <p class="text-muted font-light py-8 text-center">Sel nädalal külastusi ei ole.</p>
                    </template>
                    <div class="space-y-3">
                        <template x-for="b in weekBookings" :key="b.id">
                            <div @click="openBookingDetail(b)" class="bg-white border border-[#E8E3DD] p-5 flex flex-col md:flex-row md:items-center gap-4 cursor-pointer hover:border-accent/50 transition-colors">
                                <div class="w-24 text-center shrink-0">
                                    <p class="text-xs text-muted" x-text="formatDate(b.scheduledAt)"></p>
                                    <p class="font-serif text-lg" x-text="formatTime(b.scheduledAt)"></p>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium" x-text="b.customerName"></p>
                                    <p class="text-muted text-xs mt-1 truncate" x-text="b.address"></p>
                                </div>
                                <div class="flex gap-2 items-center shrink-0">
                                    <span class="text-xs text-muted" x-text="getSizeName(b.size)"></span>
                                    <span x-show="b.isAutoScheduled" class="px-2 py-0.5 bg-cream text-[10px] text-accent uppercase tracking-wider">Auto</span>
                                    <span x-show="b.status === 'scheduled'" class="w-2 h-2 rounded-full bg-accent"></span>
                                    <span x-show="b.status === 'completed'" class="w-2 h-2 rounded-full bg-green-500"></span>
                                    <span x-show="b.status === 'cancelled'" class="w-2 h-2 rounded-full bg-red-400"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Active Subscriptions -->
                <div x-show="activeTab === 'subscriptions' && !loading">
                    <h2 class="font-serif text-xl font-light mb-4">Aktiivsed tellimused</h2>
                    <template x-if="activeSubscriptions.length === 0">
                        <p class="text-muted font-light py-8 text-center">Aktiivseid tellimusi ei ole.</p>
                    </template>
                    <div class="space-y-3">
                        <template x-for="o in activeSubscriptions" :key="o.id">
                            <div @click="openOrderDetail(o)" class="bg-white border border-[#E8E3DD] p-5 cursor-pointer hover:border-accent/50 transition-colors">
                                <div class="flex flex-col md:flex-row md:items-center gap-4">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium" x-text="o.customer?.name"></p>
                                        <p class="text-muted text-xs mt-1" x-text="o.customer?.email"></p>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="text-xs uppercase tracking-wider text-accent" x-text="getPackageName(o.package)"></p>
                                        <p class="text-xs text-muted mt-1" x-text="getSizeName(o.size)"></p>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="text-[10px] uppercase tracking-wider text-muted">Järgmine</p>
                                        <p class="text-xs" x-text="o.nextVisitDue ? formatDate(o.nextVisitDue) : 'Pole planeeritud'"></p>
                                    </div>
                                    <div class="text-right shrink-0">
                                        <p class="text-[10px] uppercase tracking-wider text-muted">Külastusi</p>
                                        <p class="font-serif text-lg" x-text="o.totalVisits || 0"></p>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- All Orders -->
                <div x-show="activeTab === 'all' && !loading">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-serif text-xl font-light">Kõik tellimused</h2>
                        <div class="flex items-center gap-3">
                            <button x-show="pendingCount > 0" @click="showPending = !showPending" class="text-[10px] uppercase tracking-wider px-3 py-1.5 border transition-colors" :class="showPending ? 'border-accent text-accent bg-cream/50' : 'border-[#E8E3DD] text-muted hover:border-accent/50'">
                                <span x-show="!showPending">Näita katkestatud (<span x-text="pendingCount"></span>)</span>
                                <span x-show="showPending">Peida katkestatud</span>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <template x-for="o in filteredOrders" :key="o.id">
                            <div @click="openOrderDetail(o)" class="bg-white border border-[#E8E3DD] p-5 cursor-pointer hover:border-accent/50 transition-colors" :class="o.status === 'pending' ? 'opacity-50' : ''">
                                <div class="flex flex-col md:flex-row md:items-center gap-3">
                                    <div class="flex-1 min-w-0">
                                        <p class="font-medium" x-text="o.customer?.name"></p>
                                        <p class="text-muted text-xs mt-1" x-text="o.customer?.email"></p>
                                    </div>
                                    <div class="shrink-0">
                                        <span class="px-2 py-1 text-[10px] uppercase tracking-wider" :class="o.type === 'gift' ? 'bg-pink-50 text-pink-600' : 'bg-cream text-accent'" x-text="o.type === 'gift' ? 'Kingitus' : 'Tellimus'"></span>
                                    </div>
                                    <div class="text-xs text-muted shrink-0" x-text="getPackageName(o.package)"></div>
                                    <div class="shrink-0">
                                        <span class="px-2 py-1 text-[10px] uppercase tracking-wider" :class="o.status === 'paid' ? 'bg-green-50 text-green-600' : o.status === 'cancelling' ? 'bg-amber-50 text-amber-600' : o.status === 'cancelled' ? 'bg-red-50 text-red-500' : 'bg-gray-50 text-gray-500'" x-text="getStatusName(o.status)"></span>
                                    </div>
                                    <!-- Gift flow badge -->
                                    <template x-if="getGiftFlowStatus(o)">
                                        <div class="shrink-0">
                                            <span class="px-2 py-1 text-[10px] uppercase tracking-wider" :class="getGiftFlowStatus(o).color" x-text="getGiftFlowStatus(o).label"></span>
                                        </div>
                                    </template>
                                    <!-- Subscription booking badge -->
                                    <template x-if="getBookingStatus(o)">
                                        <div class="shrink-0">
                                            <span class="px-2 py-1 text-[10px] uppercase tracking-wider" :class="getBookingStatus(o).color" x-text="getBookingStatus(o).label"></span>
                                        </div>
                                    </template>
                                    <div class="text-xs text-muted shrink-0" x-text="o.createdAt ? new Date(o.createdAt).toLocaleDateString('et-EE') : ''"></div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Follow-ups -->
                <div x-show="activeTab === 'followups' && !loading">
                    <h2 class="font-serif text-xl font-light mb-4">Follow-up meilid</h2>
                    <p class="text-muted text-xs font-light mb-6">Automaatne konversioonivoog: kinkesaaja → tellija. Pärast koristust saadetakse 3 meili (24h, 7d, 30d).</p>

                    <!-- Follow-up stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-white border border-[#E8E3DD] p-4 text-center">
                            <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-1">Ootel</p>
                            <p class="font-serif text-2xl font-light text-accent" x-text="followupStats.pending">0</p>
                        </div>
                        <div class="bg-white border border-[#E8E3DD] p-4 text-center">
                            <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-1">Saadetud</p>
                            <p class="font-serif text-2xl font-light" x-text="followupStats.sent">0</p>
                        </div>
                        <div class="bg-white border border-[#E8E3DD] p-4 text-center">
                            <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-1">Konverteeritud</p>
                            <p class="font-serif text-2xl font-light text-green-600" x-text="followupStats.converted">0</p>
                        </div>
                        <div class="bg-white border border-[#E8E3DD] p-4 text-center">
                            <p class="text-[10px] uppercase tracking-[0.2em] text-muted mb-1">Kokku</p>
                            <p class="font-serif text-2xl font-light" x-text="followupStats.total">0</p>
                        </div>
                    </div>

                    <!-- Conversion rate -->
                    <div x-show="followupStats.total > 0" class="bg-cream/50 border border-[#E8E3DD] p-5 mb-8">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-1">Konversioonimäär</p>
                                <p class="font-serif text-3xl font-light" x-text="followupStats.total > 0 ? Math.round((followupStats.converted / Math.max(1, Math.floor(followupStats.total / 3))) * 100) + '%' : '0%'"></p>
                            </div>
                            <div class="text-right text-xs text-muted">
                                <p>Unikaalseid saajaid: <span class="text-black font-medium" x-text="Math.floor(followupStats.total / 3)"></span></p>
                                <p>Tellijaks saanud: <span class="text-green-600 font-medium" x-text="followupStats.converted"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Follow-up list -->
                    <template x-if="followups.length === 0 && followupsLoaded">
                        <p class="text-muted font-light py-8 text-center">Follow-up meile pole veel loodud. Need luuakse automaatselt kui kinkesaaja broneerib oma visiidi.</p>
                    </template>
                    <div class="space-y-2">
                        <template x-for="f in followups" :key="f.id">
                            <div class="bg-white border border-[#E8E3DD] p-4 flex flex-col md:flex-row md:items-center gap-3">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-sm" x-text="f.recipientEmail"></p>
                                    <p class="text-muted text-xs mt-0.5" x-text="f.recipientName || '—'"></p>
                                </div>
                                <div class="shrink-0">
                                    <span class="px-2 py-1 text-[10px] uppercase tracking-wider font-medium"
                                        :class="{
                                            'bg-yellow-50 text-yellow-600': f.stage === '24h',
                                            'bg-blue-50 text-blue-600': f.stage === '7d',
                                            'bg-purple-50 text-purple-600': f.stage === '30d',
                                            'bg-teal-50 text-teal-600': f.stage === 'subscriber_first_visit',
                                        }"
                                        x-text="f.stage === '24h' ? '24h — See tunne' : f.stage === '7d' ? '7d — Kas mäletad?' : f.stage === '30d' ? '30d — Mõtlesime sinu peale' : 'Tellija — Tere tulemast koju'"></span>
                                </div>
                                <div class="shrink-0">
                                    <span class="px-2 py-1 text-[10px] uppercase tracking-wider"
                                        :class="{
                                            'bg-gray-50 text-gray-500': f.status === 'pending',
                                            'bg-green-50 text-green-600': f.status === 'sent',
                                            'bg-accent/10 text-accent': f.status === 'converted',
                                            'bg-red-50 text-red-500': f.status === 'failed',
                                        }"
                                        x-text="f.status === 'pending' ? 'Ootel' : f.status === 'sent' ? 'Saadetud' : f.status === 'converted' ? 'Konverteeritud' : 'Ebaõnnestunud'"></span>
                                </div>
                                <div class="text-xs text-muted shrink-0">
                                    <span x-show="f.status === 'pending'" x-text="f.sendAt ? 'Saadetakse: ' + new Date(f.sendAt).toLocaleDateString('et-EE', { day: 'numeric', month: 'short' }) : ''"></span>
                                    <span x-show="f.status === 'sent'" x-text="f.sentAt ? 'Saadetud: ' + new Date(f.sentAt).toLocaleDateString('et-EE', { day: 'numeric', month: 'short' }) : ''"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Gift Cards Generator -->
                <div x-show="activeTab === 'giftcards' && !loading">
                    <h2 class="font-serif text-xl font-light mb-2">Füüsilised kinkekaardid</h2>
                    <p class="text-muted text-xs font-light mb-8">Genereeri töötavad koodid füüsilistele kinkekaartidele. Koodid aktiveeritakse kohe ja neid saab lunastada aadressil sukoda.ee/lunasta</p>

                    <!-- Generator Form -->
                    <div class="bg-white border border-[#E8E3DD] p-6 mb-8">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-5">Genereeri uued koodid</p>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                            <!-- Package -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-[0.15em] text-muted mb-2">Pakett</label>
                                <select x-model="gc.package" class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                                    <option value="moment">Üks Hetk — 1 külastus</option>
                                    <option value="month">Kuu Aega — 4 külastust</option>
                                    <option value="quarter">Kvartal Vabadust — 12 külastust</option>
                                </select>
                            </div>

                            <!-- Size -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-[0.15em] text-muted mb-2">Kodu suurus</label>
                                <select x-model="gc.size" class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                                    <option value="small">Kuni 50m²</option>
                                    <option value="medium">51–90m²</option>
                                    <option value="large">91–120m²</option>
                                    <option value="xlarge">121–150m²</option>
                                </select>
                            </div>

                            <!-- Count -->
                            <div>
                                <label class="block text-[10px] uppercase tracking-[0.15em] text-muted mb-2">Kogus</label>
                                <input type="number" x-model.number="gc.count" min="1" max="200" placeholder="10"
                                    class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                            </div>
                        </div>

                        <!-- Buyer info -->
                        <p class="text-[10px] uppercase tracking-[0.15em] text-muted mb-3 mt-2">Ostja (maakler / büroo)</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-5">
                            <div>
                                <input type="text" x-model="gc.buyerName" placeholder="Nimi"
                                    class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                            </div>
                            <div>
                                <input type="email" x-model="gc.buyerEmail" placeholder="E-post"
                                    class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                            </div>
                            <div>
                                <input type="text" x-model="gc.buyerCompany" placeholder="Ettevõte"
                                    class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                            </div>
                        </div>

                        <!-- Batch name -->
                        <div class="mb-6">
                            <label class="block text-[10px] uppercase tracking-[0.15em] text-muted mb-2">Partii nimi (valikuline)</label>
                            <input type="text" x-model="gc.batchName" placeholder="nt. Uus Maa Kinnisvarabüroo veebr 2026"
                                class="w-full border border-[#E8E3DD] bg-white px-4 py-3 text-sm font-light outline-none focus:border-accent">
                        </div>

                        <!-- Generate button -->
                        <button @click="generateGiftCards()" :disabled="gc.generating"
                            class="bg-accent text-white py-3 px-8 text-xs uppercase tracking-[0.2em] font-medium hover:bg-accent/90 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span x-show="!gc.generating">Genereeri koodid</span>
                            <span x-show="gc.generating">Genereerin...</span>
                        </button>

                        <p x-show="gc.error" class="mt-3 text-red-500 text-xs" x-text="gc.error"></p>
                    </div>

                    <!-- Generated Codes Result -->
                    <div x-show="gc.result" class="bg-white border border-[#E8E3DD] p-6 mb-8">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-1">Genereeritud koodid</p>
                                <p class="text-xs text-muted">
                                    Partii: <span class="text-black" x-text="gc.result?.batchId"></span> · 
                                    Pakett: <span class="text-black" x-text="getPackageName(gc.result?.package)"></span> · 
                                    Suurus: <span class="text-black" x-text="getSizeName(gc.result?.size)"></span> · 
                                    Ostja: <span class="text-black" x-text="gc.result?.buyer || '—'"></span>
                                </p>
                            </div>
                            <div class="flex gap-3 shrink-0">
                                <button @click="downloadGiftCSV()" class="text-xs text-white bg-accent hover:bg-accent/80 px-4 py-2 uppercase tracking-[0.15em] transition-colors">
                                    CSV trükikojale
                                </button>
                                <button @click="copyGiftCodes()" class="text-xs text-accent hover:text-accent/70 px-4 py-2 border border-accent/30 uppercase tracking-[0.15em] transition-colors">
                                    <span x-text="gc.copied ? '✓ Kopeeritud' : 'Kopeeri koodid'"></span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                            <template x-for="item in gc.result?.codes || []" :key="item.code">
                                <div class="bg-paper border border-[#E8E3DD] px-3 py-2 text-center">
                                    <p class="font-mono text-sm tracking-wider font-medium" x-text="item.code"></p>
                                </div>
                            </template>
                        </div>

                        <p class="text-xs text-muted mt-4">Kokku: <span class="text-black font-medium" x-text="gc.result?.count"></span> koodi. Kõik koodid on aktiivsed ja lunastatavad aadressil <a href="/lunasta.html" target="_blank" class="text-accent hover:underline">sukoda.ee/lunasta</a></p>
                    </div>

                    <!-- Previous batches from allOrders -->
                    <div x-show="physicalCardOrders.length > 0">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-4">Olemasolevad füüsilised kaardid</p>
                        <div class="bg-white border border-[#E8E3DD] overflow-hidden">
                            <table class="w-full text-xs">
                                <thead>
                                    <tr class="grid-line-b">
                                        <th class="text-left py-3 px-4 text-[10px] uppercase tracking-[0.15em] text-muted font-medium">Kood</th>
                                        <th class="text-left py-3 px-4 text-[10px] uppercase tracking-[0.15em] text-muted font-medium">Pakett</th>
                                        <th class="text-left py-3 px-4 text-[10px] uppercase tracking-[0.15em] text-muted font-medium">Ostja</th>
                                        <th class="text-left py-3 px-4 text-[10px] uppercase tracking-[0.15em] text-muted font-medium">Staatus</th>
                                        <th class="text-left py-3 px-4 text-[10px] uppercase tracking-[0.15em] text-muted font-medium">Loodud</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="order in physicalCardOrders" :key="order.id">
                                        <tr class="grid-line-b hover:bg-cream/30 cursor-pointer" @click="openOrderDetail(order)">
                                            <td class="py-3 px-4 font-mono tracking-wider font-medium" x-text="order.giftCode || '—'"></td>
                                            <td class="py-3 px-4" x-text="getPackageName(order.package)"></td>
                                            <td class="py-3 px-4" x-text="order.buyer?.company || order.buyer?.name || '—'"></td>
                                            <td class="py-3 px-4">
                                                <span class="px-2 py-0.5 text-[10px] uppercase tracking-wider"
                                                    :class="getGiftFlowStatus(order)?.color || 'bg-gray-50 text-gray-500'"
                                                    x-text="getGiftFlowStatus(order)?.label || getStatusName(order.status)"></span>
                                            </td>
                                            <td class="py-3 px-4 text-muted" x-text="order.createdAt ? new Date(order.createdAt).toLocaleDateString('et-EE', { day: 'numeric', month: 'short', year: 'numeric' }) : '—'"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- BOOKING DETAIL MODAL -->
    <!-- ============================================================ -->
    <div x-show="showBookingModal" x-cloak class="fixed inset-0 z-50 flex items-start justify-center pt-12 md:pt-20 px-4" @keydown.escape.window="closeBookingModal()">
        <div class="modal-backdrop fixed inset-0" @click="closeBookingModal()"></div>
        <div class="relative bg-paper border border-[#E8E3DD] shadow-xl w-full max-w-lg max-h-[85vh] overflow-y-auto" x-show="showBookingModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            
            <template x-if="selectedBooking">
                <div>
                    <!-- Header -->
                    <div class="p-6 grid-line-b flex justify-between items-start">
                        <div>
                            <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-1">Broneering</p>
                            <h3 class="font-serif text-2xl font-light" x-text="selectedBooking.customerName"></h3>
                        </div>
                        <button @click="closeBookingModal()" class="text-muted hover:text-black p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <!-- Status -->
                    <div class="px-6 py-3 grid-line-b flex items-center gap-3">
                        <span class="px-3 py-1 text-xs" :class="selectedBooking.status === 'scheduled' ? 'bg-cream text-accent' : selectedBooking.status === 'completed' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-500'" x-text="selectedBooking.status === 'scheduled' ? 'Planeeritud' : selectedBooking.status === 'completed' ? 'Tehtud' : 'Tühistatud'"></span>
                        <span x-show="selectedBooking.isAutoScheduled" class="px-2 py-0.5 bg-cream text-[10px] text-accent uppercase tracking-wider">Auto-planeeritud</span>
                    </div>

                    <!-- Time & Address -->
                    <div class="px-6 py-5 grid-line-b">
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 bg-cream flex items-center justify-center shrink-0">
                                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            </div>
                            <div>
                                <p class="font-medium" x-text="formatFullDate(selectedBooking.scheduledAt)"></p>
                                <p class="text-muted text-xs mt-1">
                                    <span x-text="formatTime(selectedBooking.scheduledAt)"></span>
                                    <span x-show="selectedBooking.endTime"> – <span x-text="formatTime(selectedBooking.endTime)"></span></span>
                                </p>
                            </div>
                        </div>
                        <div class="flex items-start gap-4 mt-4" x-show="selectedBooking.address">
                            <div class="w-10 h-10 bg-cream flex items-center justify-center shrink-0">
                                <svg class="w-5 h-5 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            </div>
                            <div>
                                <p class="font-medium" x-text="selectedBooking.address"></p>
                                <p class="text-muted text-xs mt-1" x-text="getSizeName(selectedBooking.size)"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Client Info -->
                    <div class="px-6 py-5 grid-line-b">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-muted font-medium mb-4">Kliendi andmed</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                <span x-text="selectedBooking.customerName"></span>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedBooking.customerEmail">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                <a :href="'mailto:' + selectedBooking.customerEmail" class="text-accent hover:underline" x-text="selectedBooking.customerEmail"></a>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedBooking.customerPhone">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                <a :href="'tel:' + selectedBooking.customerPhone" class="text-accent hover:underline" x-text="selectedBooking.customerPhone"></a>
                            </div>
                        </div>
                        <!-- Extra info from linked order -->
                        <template x-if="getLinkedOrder(selectedBooking)">
                            <div class="mt-4 pt-4 border-t border-[#E8E3DD]">
                                <div class="space-y-3">
                                    <div x-show="getLinkedOrder(selectedBooking)?.customer?.additionalInfo" class="text-xs text-muted">
                                        <p class="font-medium text-black mb-1">Lisainfo:</p>
                                        <p x-text="getLinkedOrder(selectedBooking)?.customer?.additionalInfo"></p>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs">
                                        <span class="text-muted">Pakett:</span>
                                        <span class="text-accent font-medium" x-text="getPackageName(getLinkedOrder(selectedBooking)?.package)"></span>
                                    </div>
                                    <div x-show="getLinkedOrder(selectedBooking)?.totalVisits !== undefined" class="flex items-center gap-2 text-xs">
                                        <span class="text-muted">Külastusi kokku:</span>
                                        <span x-text="getLinkedOrder(selectedBooking)?.totalVisits || 0"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Reschedule Section (inline) -->
                    <div x-show="rescheduleMode" class="px-6 py-5 grid-line-b bg-cream/50">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-accent font-medium mb-4">Muuda aega</p>
                        
                        <!-- Date range selector -->
                        <div class="flex items-center gap-3 mb-4">
                            <input type="date" x-model="slotStartDate" class="border border-[#E8E3DD] bg-white px-3 py-2 text-xs outline-none focus:border-accent">
                            <span class="text-muted text-xs">kuni</span>
                            <input type="date" x-model="slotEndDate" class="border border-[#E8E3DD] bg-white px-3 py-2 text-xs outline-none focus:border-accent">
                            <button @click="loadSlots()" class="px-3 py-2 bg-accent text-white text-xs hover:bg-accent/90">Otsi aegu</button>
                        </div>

                        <!-- Loading -->
                        <div x-show="slotsLoading" class="py-4 text-center">
                            <div class="w-6 h-6 border border-accent border-t-transparent rounded-full animate-spin mx-auto"></div>
                            <p class="text-xs text-muted mt-2">Otsin vabu aegu...</p>
                        </div>

                        <!-- Slots display -->
                        <div x-show="!slotsLoading && Object.keys(availableSlots).length > 0">
                            <template x-for="[date, times] in Object.entries(availableSlots)" :key="date">
                                <div class="mb-4">
                                    <p class="text-xs font-medium mb-2" x-text="formatFullDate(date + 'T12:00:00')"></p>
                                    <div class="flex flex-wrap gap-2">
                                        <template x-for="time in times" :key="time">
                                            <button @click="selectedSlot = time" class="slot-btn px-3 py-1.5 border border-[#E8E3DD] bg-white text-xs" :class="selectedSlot === time ? 'selected' : ''" x-text="formatTime(time)"></button>
                                        </template>
                                    </div>
                                </div>
                            </template>
                            
                            <div x-show="selectedSlot" class="mt-4 pt-4 border-t border-[#E8E3DD] flex items-center justify-between">
                                <p class="text-xs">
                                    Uus aeg: <strong x-text="selectedSlot ? formatFullDate(selectedSlot) + ', ' + formatTime(selectedSlot) : ''"></strong>
                                </p>
                                <button @click="confirmReschedule()" :disabled="rescheduleLoading" class="px-4 py-2 bg-accent text-white text-xs hover:bg-accent/90 disabled:opacity-50">
                                    <span x-show="!rescheduleLoading">Kinnita uus aeg</span>
                                    <span x-show="rescheduleLoading">Muudan...</span>
                                </button>
                            </div>
                        </div>

                        <div x-show="!slotsLoading && slotsSearched && Object.keys(availableSlots).length === 0" class="py-4 text-center">
                            <p class="text-xs text-muted">Vabu aegu ei leitud. Proovi teist perioodi.</p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="px-6 py-5" x-show="selectedBooking.status === 'scheduled'">
                        <div class="flex flex-wrap gap-3">
                            <button @click="completeBooking(selectedBooking.id)" class="px-4 py-2 bg-accent text-white text-xs uppercase tracking-wider hover:bg-accent/90">
                                Märgi tehtuks
                            </button>
                            <button @click="toggleReschedule()" class="px-4 py-2 border border-[#E8E3DD] text-xs uppercase tracking-wider hover:border-accent hover:text-accent" :class="rescheduleMode ? 'border-accent text-accent' : ''">
                                Muuda aega
                            </button>
                            <button @click="cancelBookingWithReason(selectedBooking.id)" class="px-4 py-2 border border-[#E8E3DD] text-xs uppercase tracking-wider text-muted hover:border-red-300 hover:text-red-500">
                                Tühista
                            </button>
                        </div>
                        <p class="text-[10px] text-muted mt-3">Tühistamisel ja aja muutmisel saadetakse kliendile automaatselt email.</p>
                    </div>

                    <!-- Cancel reason display -->
                    <div class="px-6 py-4" x-show="selectedBooking.status === 'cancelled' && selectedBooking.cancelReason">
                        <p class="text-xs text-muted">Tühistamise põhjus: <span class="text-red-500" x-text="selectedBooking.cancelReason"></span></p>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <!-- ============================================================ -->
    <!-- ORDER DETAIL MODAL -->
    <!-- ============================================================ -->
    <div x-show="showOrderModal" x-cloak class="fixed inset-0 z-50 flex items-start justify-center pt-12 md:pt-20 px-4" @keydown.escape.window="closeOrderModal()">
        <div class="modal-backdrop fixed inset-0" @click="closeOrderModal()"></div>
        <div class="relative bg-paper border border-[#E8E3DD] shadow-xl w-full max-w-lg max-h-[85vh] overflow-y-auto" x-show="showOrderModal" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-4" x-transition:enter-end="opacity-100 translate-y-0">
            
            <template x-if="selectedOrder">
                <div>
                    <!-- Header -->
                    <div class="p-6 grid-line-b flex justify-between items-start">
                        <div>
                            <p class="text-[10px] uppercase tracking-[0.2em] font-medium mb-1" :class="selectedOrder.type === 'gift' ? 'text-pink-500' : 'text-accent'" x-text="selectedOrder.type === 'gift' ? 'Kingitus' : 'Tellimus'"></p>
                            <h3 class="font-serif text-2xl font-light" x-text="selectedOrder.customer?.name"></h3>
                        </div>
                        <button @click="closeOrderModal()" class="text-muted hover:text-black p-1">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <!-- Status & Package -->
                    <div class="px-6 py-4 grid-line-b flex items-center gap-3 flex-wrap">
                        <span class="px-3 py-1 text-xs" :class="selectedOrder.status === 'paid' ? 'bg-green-50 text-green-600' : selectedOrder.status === 'cancelling' ? 'bg-amber-50 text-amber-600' : selectedOrder.status === 'cancelled' ? 'bg-red-50 text-red-500' : 'bg-gray-50 text-gray-500'" x-text="getStatusName(selectedOrder.status)"></span>
                        <span class="text-xs text-accent font-medium" x-text="getPackageName(selectedOrder.package)"></span>
                        <span class="text-xs text-muted" x-text="getSizeName(selectedOrder.size)"></span>
                        <span x-show="selectedOrder.subscriptionStatus === 'active'" class="px-2 py-0.5 bg-green-50 text-[10px] text-green-600 uppercase tracking-wider">Aktiivne</span>
                    </div>

                    <!-- Client Info -->
                    <div class="px-6 py-5 grid-line-b">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-muted font-medium mb-4">Tellija andmed</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                <span x-text="selectedOrder.customer?.name"></span>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedOrder.customer?.email">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                <a :href="'mailto:' + selectedOrder.customer?.email" class="text-accent hover:underline" x-text="selectedOrder.customer?.email"></a>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedOrder.customer?.phone">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                <a :href="'tel:' + selectedOrder.customer?.phone" class="text-accent hover:underline" x-text="selectedOrder.customer?.phone"></a>
                            </div>
                            <div class="flex items-start gap-3" x-show="selectedOrder.customer?.address">
                                <svg class="w-4 h-4 text-muted shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span x-text="selectedOrder.customer?.address"></span>
                            </div>
                            <div x-show="selectedOrder.customer?.additionalInfo" class="ml-7 text-xs text-muted bg-cream p-3 mt-2">
                                <p class="font-medium text-black mb-1">Lisainfo:</p>
                                <p x-text="selectedOrder.customer?.additionalInfo"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gift Flow Progress -->
                    <div x-show="selectedOrder.type === 'gift' && selectedOrder.status === 'paid'" class="px-6 py-4 grid-line-b bg-cream/30">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-muted font-medium mb-3">Kingituse staatus</p>
                        <div class="flex items-center gap-2">
                            <!-- Step 1: Paid -->
                            <div class="flex items-center gap-1.5">
                                <span class="w-5 h-5 rounded-full bg-green-500 text-white flex items-center justify-center">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </span>
                                <span class="text-[10px] text-green-600 font-medium">Makstud</span>
                            </div>
                            <div class="h-[1px] w-4 bg-[#E8E3DD]"></div>
                            <!-- Step 2: Email sent -->
                            <div class="flex items-center gap-1.5">
                                <span class="w-5 h-5 rounded-full bg-green-500 text-white flex items-center justify-center">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                </span>
                                <span class="text-[10px] text-green-600 font-medium">E-kiri</span>
                            </div>
                            <div class="h-[1px] w-4 bg-[#E8E3DD]"></div>
                            <!-- Step 3: Redeemed -->
                            <div class="flex items-center gap-1.5">
                                <span class="w-5 h-5 rounded-full flex items-center justify-center" :class="selectedOrder.giftRedeemed ? 'bg-green-500 text-white' : 'bg-[#E8E3DD] text-muted'">
                                    <svg x-show="selectedOrder.giftRedeemed" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    <span x-show="!selectedOrder.giftRedeemed" class="text-[9px]">3</span>
                                </span>
                                <span class="text-[10px] font-medium" :class="selectedOrder.giftRedeemed ? 'text-green-600' : 'text-muted'">Lunastatud</span>
                            </div>
                            <div class="h-[1px] w-4 bg-[#E8E3DD]"></div>
                            <!-- Step 4: Booked -->
                            <div class="flex items-center gap-1.5">
                                <span class="w-5 h-5 rounded-full flex items-center justify-center" :class="selectedOrder.booking?.startTime ? 'bg-green-500 text-white' : 'bg-[#E8E3DD] text-muted'">
                                    <svg x-show="selectedOrder.booking?.startTime" class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                                    <span x-show="!selectedOrder.booking?.startTime" class="text-[9px]">4</span>
                                </span>
                                <span class="text-[10px] font-medium" :class="selectedOrder.booking?.startTime ? 'text-green-600' : 'text-muted'">Broneeritud</span>
                            </div>
                        </div>
                        <p x-show="selectedOrder.giftRedeemedAt" class="text-[10px] text-muted mt-2">
                            Lunastatud: <span x-text="selectedOrder.giftRedeemedAt ? new Date(selectedOrder.giftRedeemedAt).toLocaleString('et-EE') : ''"></span>
                        </p>
                    </div>

                    <!-- Gift Recipient -->
                    <div x-show="selectedOrder.type === 'gift' && selectedOrder.recipient" class="px-6 py-5 grid-line-b">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-pink-500 font-medium mb-4">Kingisaaja</p>
                        <div class="space-y-3">
                            <div class="flex items-center gap-3">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                <span x-text="selectedOrder.recipient?.name"></span>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedOrder.recipient?.email">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                <a :href="'mailto:' + selectedOrder.recipient?.email" class="text-accent hover:underline" x-text="selectedOrder.recipient?.email"></a>
                            </div>
                            <div class="flex items-center gap-3" x-show="selectedOrder.recipient?.phone">
                                <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                <a :href="'tel:' + selectedOrder.recipient?.phone" class="text-accent hover:underline" x-text="selectedOrder.recipient?.phone"></a>
                            </div>
                            <div class="flex items-start gap-3" x-show="selectedOrder.recipient?.address">
                                <svg class="w-4 h-4 text-muted shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                                <span x-text="selectedOrder.recipient?.address"></span>
                            </div>
                            <div x-show="selectedOrder.recipient?.message" class="ml-7 text-xs text-muted bg-pink-50 p-3 mt-2">
                                <p class="font-medium text-pink-600 mb-1">Sõnum:</p>
                                <p x-text="selectedOrder.recipient?.message" class="italic"></p>
                            </div>
                            <div x-show="selectedOrder.recipient?.additionalInfo" class="ml-7 text-xs text-muted bg-cream p-3 mt-2">
                                <p class="font-medium text-black mb-1">Lisainfo:</p>
                                <p x-text="selectedOrder.recipient?.additionalInfo"></p>
                            </div>
                            <div x-show="selectedOrder.giftCode" class="ml-7">
                                <p class="text-xs text-muted">Kingituse kood: <span class="font-mono text-accent font-medium" x-text="selectedOrder.giftCode"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Gift Booking Info -->
                    <div x-show="selectedOrder.type === 'gift' && selectedOrder.booking?.startTime" class="px-6 py-5 grid-line-b">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-green-600 font-medium mb-4">Broneeritud külastus</p>
                        <div class="flex items-start gap-4">
                            <div class="w-10 h-10 bg-green-50 flex items-center justify-center shrink-0">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            </div>
                            <div>
                                <p class="font-medium" x-text="selectedOrder.booking?.startTime ? formatFullDate(selectedOrder.booking.startTime) : ''"></p>
                                <p class="text-muted text-xs mt-1" x-text="selectedOrder.booking?.startTime ? formatTime(selectedOrder.booking.startTime) : ''"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Details -->
                    <div x-show="selectedOrder.type === 'subscription'" class="px-6 py-5 grid-line-b">
                        <p class="text-[10px] uppercase tracking-[0.2em] text-muted font-medium mb-4">Tellimuse info</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-[10px] uppercase tracking-wider text-muted">Külastusi</p>
                                <p class="font-serif text-xl font-light" x-text="selectedOrder.totalVisits || 0"></p>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase tracking-wider text-muted">Järgmine</p>
                                <p class="text-sm" x-text="selectedOrder.nextVisitDue ? formatDate(selectedOrder.nextVisitDue) : '-'"></p>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase tracking-wider text-muted">Viimane külastus</p>
                                <p class="text-sm" x-text="selectedOrder.lastVisitAt ? formatDate(selectedOrder.lastVisitAt) : '-'"></p>
                            </div>
                            <div>
                                <p class="text-[10px] uppercase tracking-wider text-muted">Eelistatud aeg</p>
                                <p class="text-sm" x-text="selectedOrder.preferredTime || '-'"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Linked Bookings -->
                    <div class="px-6 py-5 grid-line-b">
                        <div class="flex items-center justify-between mb-4">
                            <p class="text-[10px] uppercase tracking-[0.2em] text-muted font-medium">Broneeringud</p>
                            <div x-show="orderBookingsLoading" class="w-4 h-4 border border-accent border-t-transparent rounded-full animate-spin"></div>
                        </div>
                        <div x-show="!orderBookingsLoading && orderBookings.length === 0" class="py-3 text-center">
                            <p class="text-xs text-muted">Broneeringuid ei ole.</p>
                        </div>
                        <div class="space-y-2">
                            <template x-for="b in orderBookings" :key="b.id">
                                <div @click="closeOrderModal(); $nextTick(() => openBookingDetail(b))" class="flex items-center gap-3 p-3 bg-white border border-[#E8E3DD] cursor-pointer hover:border-accent/50 transition-colors">
                                    <div class="shrink-0">
                                        <span class="w-2 h-2 rounded-full inline-block" :class="b.status === 'scheduled' ? 'bg-accent' : b.status === 'completed' ? 'bg-green-500' : 'bg-red-400'"></span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-xs font-medium" x-text="b.scheduledAt ? formatFullDate(b.scheduledAt) : '-'"></p>
                                        <p class="text-[11px] text-muted" x-text="b.scheduledAt ? formatTime(b.scheduledAt) + (b.endTime ? ' – ' + formatTime(b.endTime) : '') : ''"></p>
                                    </div>
                                    <div class="shrink-0">
                                        <span class="text-[10px] uppercase tracking-wider" :class="b.status === 'scheduled' ? 'text-accent' : b.status === 'completed' ? 'text-green-600' : 'text-red-500'" x-text="b.status === 'scheduled' ? 'Planeeritud' : b.status === 'completed' ? 'Tehtud' : 'Tühistatud'"></span>
                                    </div>
                                    <svg class="w-4 h-4 text-muted shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7"/></svg>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="px-6 py-5 grid-line-b" x-show="selectedOrder.status !== 'cancelled' && selectedOrder.status !== 'cancelling'">
                        <div class="flex flex-wrap gap-3">
                            <button @click="cancelOrderWithReason(selectedOrder.id)" class="px-4 py-2 border border-red-200 text-xs uppercase tracking-wider text-red-500 hover:bg-red-50 hover:border-red-300">
                                Tühista tellimus
                            </button>
                        </div>
                        <p class="text-[10px] text-muted mt-3" x-show="selectedOrder.type === 'subscription'">
                            Tühistab tellimuse jooksva perioodi lõpus. Klient saab praeguse perioodi teenuse, aga järgmist makset enam ei tehta. Planeeritud broneeringud tühistatakse. Kliendile saadetakse email.
                        </p>
                        <p class="text-[10px] text-muted mt-3" x-show="selectedOrder.type === 'gift'">
                            Tühistab kingituse ja seotud broneeringud. Raha tagastamiseks tee Stripe'is manuaalne refund. Kliendile saadetakse email.
                        </p>
                    </div>

                    <!-- Cancelling info (subscription pending period end) -->
                    <div class="px-6 py-4 grid-line-b" x-show="selectedOrder.status === 'cancelling'">
                        <div class="flex items-start gap-2">
                            <svg class="w-4 h-4 text-amber-500 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z"/></svg>
                            <div>
                                <p class="text-xs text-amber-700 font-medium">Tühistatakse perioodi lõpus</p>
                                <p class="text-[10px] text-muted mt-1">
                                    Klient saab jooksva perioodi teenuse.
                                    <template x-if="selectedOrder.currentPeriodEnd">
                                        <span>Tellimus lõpeb <strong x-text="new Date(selectedOrder.currentPeriodEnd).toLocaleDateString('et-EE')"></strong>.</span>
                                    </template>
                                    <template x-if="!selectedOrder.currentPeriodEnd">
                                        <span>Tellimus lõpeb automaatselt perioodi lõpus.</span>
                                    </template>
                                </p>
                                <p class="text-[10px] text-muted mt-1" x-show="selectedOrder.cancelReason">Põhjus: <span class="text-amber-600" x-text="selectedOrder.cancelReason"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Cancel info -->
                    <div class="px-6 py-4 grid-line-b" x-show="selectedOrder.status === 'cancelled'">
                        <div class="flex items-start gap-2">
                            <svg class="w-4 h-4 text-red-400 shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"/></svg>
                            <div>
                                <p class="text-xs text-red-500 font-medium">Tellimus tühistatud</p>
                                <p x-show="selectedOrder.cancelReason" class="text-xs text-muted mt-1" x-text="'Põhjus: ' + selectedOrder.cancelReason"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Order Meta -->
                    <div class="px-6 py-5">
                        <div class="flex flex-wrap gap-x-6 gap-y-2 text-xs text-muted">
                            <p>Loodud: <span x-text="selectedOrder.createdAt ? new Date(selectedOrder.createdAt).toLocaleString('et-EE') : '-'"></span></p>
                            <p x-show="selectedOrder.paidAt">Makstud: <span x-text="selectedOrder.paidAt ? new Date(selectedOrder.paidAt).toLocaleString('et-EE') : ''"></span></p>
                            <p class="text-[10px] font-mono opacity-50" x-text="'ID: ' + selectedOrder.id"></p>
                        </div>
                    </div>
                </div>
            </template>
        </div>
    </div>

    <script>
    function adminApp() {
        return {
            password: '',
            authenticated: false,
            loginError: '',
            loading: false,
            activeTab: 'today',
            todayBookings: [],
            weekBookings: [],
            activeSubscriptions: [],
            allOrders: [],
            showPending: false,

            // Booking detail modal
            showBookingModal: false,
            selectedBooking: null,

            // Order detail modal
            showOrderModal: false,
            selectedOrder: null,
            orderBookings: [],
            orderBookingsLoading: false,

            // Follow-ups
            followupStats: { pending: 0, sent: 0, converted: 0, total: 0 },
            followups: [],
            followupsLoaded: false,

            // Gift card generator
            gc: {
                package: 'moment',
                size: 'medium',
                count: 10,
                buyerName: '',
                buyerEmail: '',
                buyerCompany: '',
                batchName: '',
                generating: false,
                error: '',
                result: null,
                copied: false,
            },

            // Reschedule
            rescheduleMode: false,
            availableSlots: {},
            selectedSlot: null,
            slotsLoading: false,
            slotsSearched: false,
            rescheduleLoading: false,
            slotStartDate: '',
            slotEndDate: '',

            packages: {
                moment: 'Üks Hetk', month: 'Kuu Aega', quarter: 'Kvartal Vabadust',
                once: 'Kord kuus', twice: 'Üle nädala', weekly: 'Iga nädal', test: 'Test'
            },
            sizes: { small: 'Kuni 50m²', medium: '51-90m²', large: '91-120m²', xlarge: '121-150m²' },
            statuses: { pending: 'Ootel', paid: 'Makstud', cancelled: 'Tühistatud', cancelling: 'Tühistatakse' },

            async init() {
                const saved = sessionStorage.getItem('sukoda_admin');
                if (saved) {
                    this.password = saved;
                    await this.login();
                }
            },

            async login() {
                this.loginError = '';
                try {
                    const res = await fetch(`/api/admin/orders?password=${encodeURIComponent(this.password)}&limit=1`);
                    if (res.ok) {
                        this.authenticated = true;
                        sessionStorage.setItem('sukoda_admin', this.password);
                        await this.loadData();
                    } else {
                        this.loginError = 'Vale parool';
                    }
                } catch (e) {
                    this.loginError = 'Ühenduse viga';
                }
            },

            async loadData() {
                this.loading = true;
                try {
                    const today = new Date();
                    const todayStr = today.toISOString().split('T')[0];
                    const tomorrowStr = new Date(today.getTime() + 86400000).toISOString().split('T')[0];
                    
                    const weekEnd = new Date(today);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    const weekEndStr = weekEnd.toISOString().split('T')[0];

                    const pw = encodeURIComponent(this.password);

                    const [todayRes, weekRes, ordersRes] = await Promise.all([
                        fetch(`/api/admin/bookings?start=${todayStr}&end=${tomorrowStr}&password=${pw}`),
                        fetch(`/api/admin/bookings?start=${todayStr}&end=${weekEndStr}&password=${pw}`),
                        fetch(`/api/admin/orders?password=${pw}&limit=50`),
                    ]);

                    if (todayRes.ok) {
                        const data = await todayRes.json();
                        this.todayBookings = data.bookings || [];
                    }
                    if (weekRes.ok) {
                        const data = await weekRes.json();
                        this.weekBookings = data.bookings || [];
                    }
                    if (ordersRes.ok) {
                        const data = await ordersRes.json();
                        this.allOrders = data.orders || [];
                        this.activeSubscriptions = this.allOrders.filter(o => 
                            o.type === 'subscription' && o.status === 'paid' && o.subscriptionStatus === 'active'
                        );
                    }

                    // Load follow-up data
                    try {
                        const followupRes = await fetch(`/api/admin/followups?password=${pw}`);
                        if (followupRes.ok) {
                            const data = await followupRes.json();
                            this.followupStats = data.stats || { pending: 0, sent: 0, converted: 0, total: 0 };
                            this.followups = data.followups || [];
                            this.followupsLoaded = true;
                        }
                    } catch (e) {
                        console.error('Failed to load followups:', e);
                    }

                } catch (e) {
                    console.error('Failed to load data:', e);
                }
                this.loading = false;
            },

            // ---- Booking Detail Modal ----

            openBookingDetail(booking) {
                this.selectedBooking = booking;
                this.showBookingModal = true;
                this.rescheduleMode = false;
                this.availableSlots = {};
                this.selectedSlot = null;
                this.slotsSearched = false;
            },

            closeBookingModal() {
                this.showBookingModal = false;
                this.selectedBooking = null;
                this.rescheduleMode = false;
            },

            getLinkedOrder(booking) {
                if (!booking?.orderId) return null;
                return this.allOrders.find(o => o.id === booking.orderId) || null;
            },

            // ---- Order Detail Modal ----

            async openOrderDetail(order) {
                this.selectedOrder = order;
                this.showOrderModal = true;
                this.orderBookings = [];
                this.orderBookingsLoading = true;

                // Load linked bookings
                const pw = encodeURIComponent(this.password);
                try {
                    const res = await fetch(`/api/admin/order-bookings?orderId=${order.id}&password=${pw}`);
                    if (res.ok) {
                        const data = await res.json();
                        this.orderBookings = data.bookings || [];
                    }
                } catch (e) {
                    console.error('Failed to load order bookings:', e);
                }
                this.orderBookingsLoading = false;
            },

            closeOrderModal() {
                this.showOrderModal = false;
                this.selectedOrder = null;
                this.orderBookings = [];
            },

            async cancelOrderWithReason(orderId) {
                const order = this.selectedOrder;
                let promptMsg = '';
                if (order?.type === 'gift') {
                    promptMsg = 'Kingituse tühistamise põhjus (valikuline).\n\n⚠️ Kingitus tühistatakse ja seotud broneeringud kustutatakse.\nRaha tagastamiseks tee Stripe\'is manuaalne refund.\nKliendile saadetakse tühistamise email:';
                } else {
                    promptMsg = 'Tellimuse tühistamise põhjus (valikuline).\n\n⚠️ Tellimus tühistatakse jooksva perioodi LÕPUS.\nKlient saab praeguse perioodi teenuse.\nJärgmist makset enam ei tehta.\nPlaneeritud broneeringud tühistatakse.\nKliendile saadetakse email:';
                }
                const reason = prompt(promptMsg);
                if (reason === null) return;
                try {
                    const res = await fetch('/api/admin/cancel-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ orderId, password: this.password, reason }),
                    });
                    if (res.ok) {
                        const data = await res.json();
                        let msg = '';
                        if (order?.type === 'gift') {
                            msg = 'Kingitus tühistatud.';
                            if (data.cancelledBookings > 0) msg += ` ${data.cancelledBookings} broneeringut tühistatud.`;
                            msg += '\n\nRaha tagastamiseks mine Stripe dashboardi.';
                        } else {
                            msg = 'Tellimus tühistatakse jooksva perioodi lõpus.';
                            if (data.periodEnd) msg += `\nLõpeb: ${new Date(data.periodEnd).toLocaleDateString('et-EE')}`;
                            if (data.keptBookings > 0) msg += `\n✓ ${data.keptBookings} broneering(ut) jooksvas perioodis jäävad alles.`;
                            if (data.cancelledBookings > 0) msg += `\n✕ ${data.cancelledBookings} tulevast broneeringut tühistatud.`;
                        }
                        alert(msg);
                        this.closeOrderModal();
                        await this.loadData();
                    } else {
                        const err = await res.json();
                        alert('Viga: ' + (err.error || 'Tundmatu viga'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Ühenduse viga');
                }
            },

            // ---- Actions ----

            async completeBooking(bookingId) {
                if (!confirm('Märgi külastus tehtuks?')) return;
                try {
                    const res = await fetch('/api/admin/complete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bookingId, password: this.password }),
                    });
                    if (res.ok) {
                        this.closeBookingModal();
                        await this.loadData();
                    } else {
                        alert('Viga: ' + (await res.json()).error);
                    }
                } catch (e) { console.error(e); alert('Ühenduse viga'); }
            },

            async cancelBookingWithReason(bookingId) {
                const reason = prompt('Tühistamise põhjus (valikuline).\nKliendile saadetakse tühistamise email:');
                if (reason === null) return;
                try {
                    const res = await fetch('/api/admin/cancel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bookingId, password: this.password, reason }),
                    });
                    if (res.ok) {
                        this.closeBookingModal();
                        await this.loadData();
                    } else {
                        alert('Viga: ' + (await res.json()).error);
                    }
                } catch (e) { console.error(e); alert('Ühenduse viga'); }
            },

            // ---- Reschedule ----

            toggleReschedule() {
                this.rescheduleMode = !this.rescheduleMode;
                if (this.rescheduleMode) {
                    // Default: next 2 weeks
                    const start = new Date();
                    start.setDate(start.getDate() + 1);
                    const end = new Date();
                    end.setDate(end.getDate() + 15);
                    this.slotStartDate = start.toISOString().split('T')[0];
                    this.slotEndDate = end.toISOString().split('T')[0];
                    this.availableSlots = {};
                    this.selectedSlot = null;
                    this.slotsSearched = false;
                }
            },

            async loadSlots() {
                if (!this.selectedBooking) return;
                this.slotsLoading = true;
                this.slotsSearched = false;
                this.availableSlots = {};
                this.selectedSlot = null;

                const eventTypeSlug = this.selectedBooking.eventTypeSlug || this.getEventTypeSlug(this.selectedBooking.size);
                const pw = encodeURIComponent(this.password);

                try {
                    const res = await fetch(`/api/admin/slots?eventTypeSlug=${eventTypeSlug}&startDate=${this.slotStartDate}&endDate=${this.slotEndDate}&password=${pw}`);
                    if (res.ok) {
                        const data = await res.json();
                        this.availableSlots = data.slots || {};
                    } else {
                        const err = await res.json();
                        alert('Viga aegade laadimisel: ' + (err.error || 'Tundmatu viga'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Ühenduse viga aegade laadimisel');
                }
                this.slotsLoading = false;
                this.slotsSearched = true;
            },

            async confirmReschedule() {
                if (!this.selectedSlot || !this.selectedBooking) return;

                const newDate = new Date(this.selectedSlot);
                const confirmMsg = `Muuda visiidi aeg:\n\n${this.formatFullDate(this.selectedBooking.scheduledAt)}, ${this.formatTime(this.selectedBooking.scheduledAt)}\n→ ${this.formatFullDate(this.selectedSlot)}, ${this.formatTime(this.selectedSlot)}\n\nKliendile saadetakse teavitus email.`;
                
                if (!confirm(confirmMsg)) return;

                this.rescheduleLoading = true;
                try {
                    const res = await fetch('/api/admin/reschedule', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            bookingId: this.selectedBooking.id,
                            newStartTime: this.selectedSlot,
                            password: this.password,
                        }),
                    });
                    if (res.ok) {
                        this.closeBookingModal();
                        await this.loadData();
                    } else {
                        const err = await res.json();
                        alert('Viga aja muutmisel: ' + (err.error || 'Tundmatu viga'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('Ühenduse viga');
                }
                this.rescheduleLoading = false;
            },

            getEventTypeSlug(size) {
                const slugs = { small: 'koristus-50', medium: 'koristus-90', large: 'koristus-120', xlarge: 'koristus-150' };
                return slugs[size] || 'koristus-90';
            },

            // ---- Gift Card Generator ----

            async generateGiftCards() {
                this.gc.error = '';
                this.gc.result = null;
                this.gc.generating = true;
                this.gc.copied = false;

                try {
                    const res = await fetch('/api/admin/generate-gift-cards', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            password: this.password,
                            count: this.gc.count,
                            package: this.gc.package,
                            size: this.gc.size,
                            batchName: this.gc.batchName,
                            buyer: {
                                name: this.gc.buyerName,
                                email: this.gc.buyerEmail,
                                company: this.gc.buyerCompany,
                            },
                        }),
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        this.gc.error = data.error || 'Viga genereerimisel';
                        return;
                    }

                    this.gc.result = data;

                    // Reload orders to show the new physical cards
                    await this.loadData();
                } catch (e) {
                    this.gc.error = 'Ühenduse viga: ' + e.message;
                } finally {
                    this.gc.generating = false;
                }
            },

            copyGiftCodes() {
                if (!this.gc.result?.codes) return;
                const text = this.gc.result.codes.map(c => c.code).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    this.gc.copied = true;
                    setTimeout(() => this.gc.copied = false, 3000);
                });
            },

            downloadGiftCSV() {
                if (!this.gc.result?.codes) return;
                const r = this.gc.result;
                const pkgName = this.getPackageName(r.package);
                const sizeName = this.getSizeName(r.size);

                // BOM for Excel UTF-8 compatibility
                let csv = '\uFEFF';
                csv += 'Nr;Kood;Pakett;Suurus;Partii;Ostja;Lunasta\n';
                r.codes.forEach((item, i) => {
                    csv += `${i + 1};${item.code};${pkgName};${sizeName};${r.batchId};${r.buyer || ''};sukoda.ee/lunasta?code=${item.code}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `SUKODA-koodid-${r.batchId}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            },

            get physicalCardOrders() {
                return this.allOrders.filter(o => o.physicalCard === true);
            },

            // ---- Formatting ----

            formatTime(isoStr) {
                if (!isoStr) return '';
                const d = new Date(isoStr);
                return d.toLocaleTimeString('et-EE', { hour: '2-digit', minute: '2-digit' });
            },

            formatDate(isoStr) {
                if (!isoStr) return '';
                const d = new Date(isoStr);
                return d.toLocaleDateString('et-EE', { day: 'numeric', month: 'short' });
            },

            formatFullDate(isoStr) {
                if (!isoStr) return '';
                const d = new Date(isoStr);
                const days = ['Pühapäev', 'Esmaspäev', 'Teisipäev', 'Kolmapäev', 'Neljapäev', 'Reede', 'Laupäev'];
                return `${days[d.getDay()]}, ${d.toLocaleDateString('et-EE', { day: 'numeric', month: 'long', year: 'numeric' })}`;
            },

            getPackageName(pkg) { return this.packages[pkg] || pkg || ''; },
            getSizeName(size) { return this.sizes[size] || size || ''; },
            getStatusName(status) { return this.statuses[status] || status || ''; },

            // Filtered orders (hide pending by default)
            get filteredOrders() {
                if (this.showPending) return this.allOrders;
                return this.allOrders.filter(o => o.status !== 'pending');
            },

            get paidOrdersCount() {
                return this.allOrders.filter(o => o.status !== 'pending').length;
            },

            get pendingCount() {
                return this.allOrders.filter(o => o.status === 'pending').length;
            },

            // Gift flow status
            getGiftFlowStatus(order) {
                if (order.type !== 'gift' || order.status !== 'paid') return null;
                if (order.booking?.startTime) return { label: 'Broneeritud', color: 'bg-green-50 text-green-600' };
                if (order.giftRedeemed) return { label: 'Lunastatud', color: 'bg-orange-50 text-orange-600' };
                return { label: 'Ootab lunastamist', color: 'bg-gray-100 text-gray-500' };
            },

            // Subscription booking status
            getBookingStatus(order) {
                if (order.type === 'gift') return null;
                if (order.status !== 'paid') return null;
                if (order.booking?.startTime) return { label: 'Aeg valitud', color: 'bg-green-50 text-green-600' };
                return { label: 'Aeg valimata', color: 'bg-yellow-50 text-yellow-600' };
            },
        };
    }
    </script>
</body>
</html>
